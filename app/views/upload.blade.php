<form id="fileupload" action="{{ URL::action('HomeController@upload') }}" method="POST" enctype="multipart/form-data" style="padding:10px;">
	<!-- The fileupload-buttonbar contains buttons to add/delete files and start/cancel the upload -->
	<div class="row fileupload-buttonbar">
		<div class="col-lg-7">
			<!-- The fileinput-button span is used to style the file input field as button -->
			<span class="btn btn-success fileinput-button">
				<i class="glyphicon glyphicon-plus"></i>
				<span>Add files...</span>
				{{ Form::file('files', array('multiple'=>true)); }}
			</span>
			<button type="submit" class="btn btn-primary start">
				<i class="glyphicon glyphicon-upload"></i>
				<span>Start upload</span>
			</button>
			<button type="reset" class="btn btn-warning cancel">
				<i class="glyphicon glyphicon-ban-circle"></i>
				<span>Cancel upload</span>
			</button>
			<!-- The global file processing state -->
			<span class="fileupload-process"></span>
		</div>
		<!-- The global progress state -->
		<div class="col-lg-5 fileupload-progress fade">
			<!-- The global progress bar -->
			<div class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100">
				<div class="progress-bar progress-bar-success" style="width:0%;"></div>
			</div>
			<!-- The extended global progress state -->
			<div class="progress-extended">&nbsp;</div>
		</div>
	</div>
	<!-- The table listing the files available for upload/download -->
	<table role="presentation" class="table table-striped" style="table-layout:fixed;">
		<tbody class="files"></tbody>
	</table>
</form>

<!-- The template to display files available for upload -->
<script id="template-upload" type="text/x-tmpl">
	{% for (var i=0, file; file=o.files[i]; i++) { %}
		<tr class="template-upload fade">
			<td style="vertical-align:middle;" class="col-lg-3">
				<p><span class="label label-danger">File name</span><span class="name" style="word-break: break-all; vertical-align: middle;"> {%=file.name%}</span></p>
				<strong class="error text-danger"></strong>
				<div>
				<span class="label label-info">Tags</span>
				{{ Form::text('tag_{%=file.name%}', null, array('class' => 'form-control tags', 'style' => 'opacity: 0; width: inherit; display: inline;')) }}
				</div>
			</td>
			<td style="vertical-align:middle;" class="col-lg-3">
				<p><span class="label label-primary">File size</span> <span  style="vertical-align: middle;" class="size"> Processing...</span></p>
				<div style="margin-bottom: 5px;" class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"><div class="progress-bar progress-bar-success" style="width:0%;"></div></div>
				<p><span class="label label-warning">Upload to VirusTotal</span> {{ Form::checkbox('VTscan', 'true', false, array('style' => 'vertical-align:sub;')) }}</p>
			</td>
			<td style="vertical-align:middle;" class="col-lg-4">
				<div class="box box-success">
					<div class="box-header">
						<h3 class="box-title">Writeups</h3>
						<div class="box-tools pull-right">
							<button class="btn btn-success btn-sm" data-widget="collapse"><i class="fa fa-minus"></i></button>
						</div>
					</div>
					<div class="box-body">
						<div id="writeup" style="margin-top: 2px;">
							<input class="input form-control" style="display:inline; width:90%;" name="writeup_{%=file.name%}[]" type="text" />
							<button class="btn-sm add-more" style="margin: 2px; padding: 1px 6px;" type="button"><i class="fa fa-plus"></i></button>
						</div>
					</div>
				</div>
			</td>
			<td style="vertical-align:middle; text-align: right;" class="col-lg-1">
				{% if (!i && !o.options.autoUpload) { %}
					<button class="btn btn-primary start" disabled>
						<i class="glyphicon glyphicon-upload"></i>
						<span>Start</span>
					</button>
				{% } %}
			</td>
			<td style="vertical-align:middle; text-align: left;" class="col-lg-1 td-center">
				{% if (!i) { %}
					<button class="btn btn-warning cancel">
						<i class="glyphicon glyphicon-ban-circle"></i>
						<span>Cancel</span>
					</button>
				{% } %}
			</td>
		</tr>
	{% } %}
</script>
<!-- The template to display files available for download -->
<script id="template-download" type="text/x-tmpl">
</script>
@section('javascript')
<script type="text/javascript">

function autocomplete_tag()
{
	$('input.tags:text').each(function() {
		$(this).selectize({
			plugins: ['remove_button'],
			delimiter: ';',
			persist: false,
			createOnBlur: true,
			create: true,
			options: [],
			valueField: 'tag',
			labelField: 'tag',
			searchField: 'tag',
			render: {
				option: function(data, escape) {
					return '<div><b>' +escape(data.tag)+'</b><div>';
				},
				option_create: function(data) {
					return '<div><i>' +data.input+'</i><div>';
				}
			},
			load: function(query, callback) {
				if (!query.length) return callback();
				$.ajax({
					url: "/index.php/tag",
					type: 'POST',
					dataType: 'json',
					data: {
						keyword: query
					},
					error: function() {
						callback();
					},
					success: function(res) {
						callback(res.tags);
					}
				});
			}
		});
	});
}

$(function() {
	'use strict';

	// writeups widget
	$(document).on('click','.add-more',function(e){
		e.preventDefault();
		var parent = $(this).closest('div#writeup');
		var i = parent.find('input').attr('name');
		var newHMTL = 	'<div id="writeup" style="margin-top: 2px;">' +
						'<input class="input form-control" style="display:inline; width:90%;" name="' + i + '" type="text" />' +
						'<button class="btn-sm btn-danger remove-me" style="margin: 5px;padding: 1px 6px;" type="button"><i class="fa fa-minus"></i></button>' +
						'</div>';
		var d = parent.after($(newHMTL));
	});

	$(document).on('click', '.remove-me', function(e) {
		e.preventDefault();
		$(this).closest('div#writeup').remove();
	});

	// Initialize the jQuery File Upload widget:
	$('#fileupload').fileupload({
		// Uncomment the following to send cross-domain cookies:
		//xhrFields: {withCredentials: true},
		url: "{{ URL::action('HomeController@upload') }}",
	});

	$('#fileupload').bind('fileuploadadd', function (e, data) {
		setTimeout(autocomplete_tag, 100);
	});
	
	// Enable iframe cross-domain access via redirect option:
	$('#fileupload').fileupload(
		'option',
		'redirect',
		window.location.href.replace(
			/\/[^\/]*$/,
			'/cors/result.html?%s'
			)
		);
});
</script>
@stop
